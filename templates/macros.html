{# 获取翻译文本的 macro #}
{% macro t(key) %}
{%- set lang = lang | default(value=config.default_language) -%}
{# 优先使用用户在 extra.i18n 中的覆盖 #}
{%- if config.extra.i18n and config.extra.i18n[key] -%}
{{ config.extra.i18n[key] }}
{# 否则使用主题内置翻译 #}
{%- else -%}
{%- set theme_translations = load_data(path="i18n/" ~ lang ~ ".toml") -%}
{%- if theme_translations and theme_translations[key] -%}
{{ theme_translations[key] }}
{%- else -%}
{{ key }}
{%- endif -%}
{%- endif -%}
{% endmacro t %}

{# 根据语言格式化日期的 macro #}
{% macro locale_date(date) %}
{%- set lang = lang | default(value=config.default_language) -%}
{# 获取日期格式 #}
{%- if config.extra.i18n and config.extra.i18n.date_format -%}
{%- set format = config.extra.i18n.date_format -%}
{%- else -%}
{%- set theme_translations = load_data(path="i18n/" ~ lang ~ ".toml") -%}
{%- set format = theme_translations.date_format | default(value="%Y-%m-%d") -%}
{%- endif -%}
{{ date | date(format=format) }}
{% endmacro locale_date %}

{% macro card(title="", content="", class="") %}
<div class="card {{ class }}">
    {% if title %}
    <h3>{{ title }}</h3>
    {% endif %}
    <div class="card-content">
        {{ content | safe }}
    </div>
</div>
{% endmacro card %}

{% macro post_card(page) %}
<div class="card post-card {% if page.extra.type is defined and page.extra.type == 'music' %}music-card{% endif %}">
    {% if page.extra.cover %}
    <div class="card-cover">
        <img src="{{ get_url(path=page.extra.cover) }}" alt="{{ page.title }} cover">
    </div>
    {% endif %}
    
    <div class="card-content">
        <h2 class="post-title"><a href="{{ page.permalink }}" class="card-link">{{ page.title }}</a></h2>
        
        {% if page.extra.type is defined and page.extra.type == "music" %}
        <div class="music-meta">
            <span class="artist">{{ page.extra.author }}</span>
            {% if page.extra.feat %}
            <span class="feat">feat. {{ page.extra.feat }}</span>
            {% endif %}
        </div>
        {% else %}
        <div class="post-meta">
            <time>{{ self::locale_date(date=page.date) }}</time>
        </div>
        <p>{{ page.description | default(value=page.content | striptags | truncate(length=100)) }}</p>
        {% endif %}
    </div>
    
    {% if page.extra.type is defined and page.extra.type == "music" %}
        {% if page.extra.music_link %}
        <a href="{{ page.extra.music_link }}" class="music-accent-bar-link" target="_blank" rel="noopener noreferrer">
            <div class="music-accent-bar">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="30 20 290 310" class="music-icon">
                    <path d="M254.5,55c-0.87,0.08-8.6,1.45-9.53,1.64l-107,21.59l-0.04,0.01c-2.79,0.59-4.98,1.58-6.67,3c-2.04,1.71-3.17,4.13-3.6,6.95c-0.09,0.6-0.24,1.82-0.24,3.62c0,0,0,109.32,0,133.92c0,3.13-0.25,6.17-2.37,8.76c-2.12,2.59-4.74,3.37-7.81,3.99c-2.33,0.47-4.66,0.94-6.99,1.41c-8.84,1.78-14.59,2.99-19.8,5.01c-4.98,1.93-8.71,4.39-11.68,7.51c-5.89,6.17-8.28,14.54-7.46,22.38c0.7,6.69,3.71,13.09,8.88,17.82c3.49,3.2,7.85,5.63,12.99,6.66c5.33,1.07,11.01,0.7,19.31-0.98c4.42-0.89,8.56-2.28,12.5-4.61c3.9-2.3,7.24-5.37,9.85-9.11c2.62-3.75,4.31-7.92,5.24-12.35c0.96-4.57,1.19-8.7,1.19-13.26l0-116.15c0-6.22,1.76-7.86,6.78-9.08c0,0,88.94-17.94,93.09-18.75c5.79-1.11,8.52,0.54,8.52,6.61l0,79.29c0,3.14-0.03,6.32-2.17,8.92c-2.12,2.59-4.74,3.37-7.81,3.99c-2.33,0.47-4.66,0.94-6.99,1.41c-8.84,1.78-14.59,2.99-19.8,5.01c-4.98,1.93-8.71,4.39-11.68,7.51c-5.89,6.17-8.49,14.54-7.67,22.38c0.7,6.69,3.92,13.09,9.09,17.82c3.49,3.2,7.85,5.56,12.99,6.6c5.33,1.07,11.01,0.69,19.31-0.98c4.42-0.89,8.56-2.22,12.5-4.55c3.9-2.3,7.24-5.37,9.85-9.11c2.62-3.75,4.31-7.92,5.24-12.35c0.96-4.57,1-8.7,1-13.26V64.46C263.54,58.3,260.29,54.5,254.5,55z"/>
                </svg>
            </div>
        </a>
        {% else %}
        <div class="music-accent-bar"></div>
        {% endif %}
    {% endif %}
</div>
{% endmacro post_card %}
